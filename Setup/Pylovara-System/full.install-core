#!/bin/bash

# ðŸ’¡ Pylovara Root-Installer
# fÃ¼hre aus mit: sudo ./installer.pylovara

set -e
PV_DIR="/Pylovara"
REPO_URL="https://github.com/Pylovara/Pylovara.git"
WRAPPER_NAME="pylovara.wrapper-shell"
WRAPPER_PATH="/usr/local/bin/$WRAPPER_NAME"

echo "ðŸ“¦ Starte Pylovara Setup..."

# 1. Root-PrÃ¼fung
if [ "$EUID" -ne 0 ]; then
  echo "âŒ Dieses Skript muss als root laufen (sudo)"
  exit 1
fi

# 2. Ordner vorbereiten
if [ -d "$PV_DIR" ]; then
  echo "ðŸ” Entferne alte Installation..."
  rm -rf "$PV_DIR"
fi

echo "â¬‡ï¸ Klone Repository..."
git clone "$REPO_URL" "$PV_DIR"

# 3. Wrapper setzen
if [ -f "$PV_DIR/Setup/Pylovara-System/usr/bin/$WRAPPER_NAME" ]; then
  cp "$PV_DIR/Setup/Pylovara-System/usr/bin/$WRAPPER_NAME" "$WRAPPER_PATH"
  chmod +x "$WRAPPER_PATH"
else
  echo "âŒ Wrapper nicht gefunden: $PV_DIR/Setup/Pylovara-System/usr/bin/$WRAPPER_NAME"
  exit 1
fi

# 4. In /etc/shells eintragen
if ! grep -Fxq "$WRAPPER_PATH" /etc/shells; then
  echo "$WRAPPER_PATH" >> /etc/shells
fi

# 5. Standard-Shell setzen fÃ¼r echten Nutzer
REAL_USER=${SUDO_USER:-$(logname)}
chsh -s "$WRAPPER_PATH" "$REAL_USER" || {
  echo "âš ï¸ Fehler beim chsh â€“ bitte manuell ausfÃ¼hren: chsh -s $WRAPPER_PATH"
}

# 6. Optional .bashrc/.zshrc ergÃ¤nzen
USER_HOME=$(eval echo "~$REAL_USER")
if [ -f "$USER_HOME/.bashrc" ]; then
  grep -q "source $PV_DIR/Control/control.pv-conf" "$USER_HOME/.bashrc" || \
    echo "source $PV_DIR/Control/control.pv-conf" >> "$USER_HOME/.bashrc"
fi

if [ -f "$USER_HOME/.zshrc" ]; then
  grep -q "source $PV_DIR/Control/control.pv-conf" "$USER_HOME/.zshrc" || \
    echo "source $PV_DIR/Control/control.pv-conf" >> "$USER_HOME/.zshrc"
fi

echo ""
echo "âœ… Pylovara erfolgreich installiert."
echo "ðŸ”„ Bitte neu anmelden oder Shell neu starten:"
echo "exec $WRAPPER_PATH <- SystemBrigde"
