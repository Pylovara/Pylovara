#!/bin/bash
# updater 0.3 version

# ğŸ’¡ Pylovara Updater (Reinstaller)
# FÃ¼hrt einen kompletten Update-Vorgang durch:
# Entfernt alte Installationen, klont Repo neu, kopiert in Keller

set -e
REPO_URL="https://github.com/Pylovara/Pylovara.git"
PV_DIR="/Pylovara"
WRAPPER_NAME="pylovara.wrapper-shell"
WRAPPER_PATH="/usr/local/bin/$WRAPPER_NAME"
TMP_DIR="/tmp/pylovara-latest"

echo "ğŸ› ï¸  Starte Pylovara-Update-Vorgang..."

# 1. Root-PrÃ¼fung
if [ "$EUID" -ne 0 ]; then
  echo "âŒ Dieses Skript muss mit sudo ausgefÃ¼hrt werden!"
  exit 1
fi

# 2. Alte Installationen lÃ¶schen
echo "ğŸ§¹ Entferne alte Installationen..."
rm -rf "$PV_DIR"
rm -rf "/home/"*/Pylovara 2>/dev/null || true

# 3. TMP-Verzeichnis vorbereiten
rm -rf "$TMP_DIR"
echo "â¬‡ï¸ Klone Repository nach TMP..."
git clone "$REPO_URL" "$TMP_DIR"

# 4. In Keller verschieben
echo "ğŸ“¦ Installiere neue Version nach $PV_DIR..."
cp -r "$TMP_DIR" "$PV_DIR"

# 5. Wrapper setzen
if [ -f "$PV_DIR/Setup/usr/bin/$WRAPPER_NAME" ]; then
  cp "$PV_DIR/Setup/usr/bin/$WRAPPER_NAME" "$WRAPPER_PATH"
  chmod +x "$WRAPPER_PATH"
else
  echo "âŒ Wrapper nicht gefunden: $PV_DIR/Setup/usr/bin/$WRAPPER_NAME"
  exit 1
fi

# 6. /etc/shells aktualisieren
if ! grep -Fxq "$WRAPPER_PATH" /etc/shells; then
  echo "$WRAPPER_PATH" >> /etc/shells
fi

# 7. Shell fÃ¼r echten Nutzer setzen
REAL_USER=${SUDO_USER:-$(logname)}
chsh -s "$WRAPPER_PATH" "$REAL_USER" || \
  echo "âš ï¸ Fehler bei chsh â€“ manuell ausfÃ¼hren: chsh -s $WRAPPER_PATH"

# 8. ~/.bashrc / ~/.zshrc ergÃ¤nzen
USER_HOME=$(eval echo "~$REAL_USER")
if [ -f "$USER_HOME/.bashrc" ]; then
  grep -q "source $PV_DIR/Control/control.pv-conf" "$USER_HOME/.bashrc" || \
    echo "source $PV_DIR/Control/control.pv-conf" >> "$USER_HOME/.bashrc"
fi
if [ -f "$USER_HOME/.zshrc" ]; then
  grep -q "source $PV_DIR/Control/control.pv-conf" "$USER_HOME/.zshrc" || \
    echo "source $PV_DIR/Control/control.pv-conf" >> "$USER_HOME/.zshrc"
fi

# 9. TMP lÃ¶schen
echo "ğŸ§½ Entferne temporÃ¤re Daten..."
rm -rf "$TMP_DIR"

echo ""
echo "âœ… Pylovara wurde aktualisiert und neu installiert."
echo "ğŸ” Starte neue Shell mit:"
echo "exec $WRAPPER_PATH"
